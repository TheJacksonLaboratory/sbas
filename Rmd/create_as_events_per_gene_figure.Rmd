# Figure Generation Notebook - AS_events_per_gene

This notebook creates a single figure AS_events_per_gene

## Pre-requiste

This figure generation assumes `countGenesAndEvents.ipynb` has been run.  
Order of execution is as follows:

| Step | Program  | Description |
| - | - | -|
| 1 | https://github.com/lifebit-ai/rmats-nf | nextFlow pipeline used to generate `rmats_final` results |
| 2 | `differentialGeneExpressionAnalysis.ipynb` | Using GTEx V8 release data perform sex-biased differential analysis |
| 3 | `differentialSplicingGunctionAnalysis.ipynb` | Using both annotations from GTEx V8 and gencode.v30.annotation.gtf perform sex*as_event analysis |
| 4 | `countGenesAndEvents.ipynb` | Calculate summary information on both gene and alternative splicing |

It is assumed the steps 1-4 have been completed prior to executing this notebook.

## Figures (PDF files) created by this notebook
Output PDF Figures are written to the ``pdf/`` directory.

 **AS_events_per_gene.pdf**: Plot showing genes with the most common AS events across tissues.


```{r}
library(ggplot2)
library(dplyr)
library(tidyverse)
```

**"../data/gene_as.tsv"** was generated by **countGenesAndEvents.ipynb**

```{r}
filename <- "../data/gene_as.tsv"
gene_as <- read.table(filename, header=TRUE, sep="\t",
                               skipNul=FALSE, stringsAsFactors = FALSE)
head(gene_as,2)
```

### Figure for Genes with more than 10 alternative splicing events

```{r}
# Colors for uniformity
# Let's use the following colors for uniformity
darkblue <- "#3c5488"
red <- "#e64b35"
nearlyblack <- "#040C04"
purple <- "#790079"
orange = "#ff9900"
```

```{r}
res <- gene_as %>% 
       group_by(GeneSymbol) %>% 
       count(GeneSymbol) %>% 
       arrange(desc(n)) %>% 
       as.data.frame()
res$GeneSymbol <- factor(res$GeneSymbol, levels = res$GeneSymbol)
length(res$GeneSymbol)

#Add number of tissues
nTissues <- rep(NA, length(res))
for (i in 1:nrow(res)) {
  df_gene <- gene_as %>% filter(GeneSymbol == res$GeneSymbol[i])
  nTissues[i] <- length(unique(df_gene$Tissue))
}
res$Tissues <- nTissues
head(res)

sorted_res <- res
sorted_res$Tissues <- as.numeric(as.character(sorted_res$Tissues))
sorted_res <- res[order(-res$Tissues),]
sorted_res <- sorted_res[sorted_res$Tissues > 4, ]
drops <- c("n")
sorted_res <- sorted_res[ , !(names(sorted_res) %in% drops)]
sorted_res

```

```{r}
g <- ggplot(sorted_res, aes(x = reorder(GeneSymbol,-Tissues), y = Tissues)) +
  geom_point(colour = darkblue, size = 5) +
  theme_bw() +
  theme(axis.text.x = element_text(size=24, angle = 270, hjust = 0.0, vjust = 0.5),
        axis.text.y = element_text(size=24),
        axis.title.x = element_blank(),
        axis.title.y = element_text(face="plain", colour="black", size=22),
        legend.title=element_blank(),
        legend.position = "none" ) +
  ylab(paste("Tissues"))
ggsave("../pdf/AS_events_per_gene.pdf",g)
message("Saved plot as ../pdf/AS_events_per_gene.pdf")
g

```

### Appendix - Metadata

For replicability and reproducibility purposes, we also print the following metadata:

1. Checksums of **'artefacts'**, files generated during the analysis and stored in the folder directory **`data`**
2. List of environment metadata, dependencies, versions of libraries using `utils::sessionInfo()` and [`devtools::session_info()`](https://devtools.r-lib.org/reference/session_info.html)


### Appendix 1. Checksums with the sha256 algorithm

```{r}
notebookid   = "create_as_events_per_gene"
notebookid

```

###Â Appendix 2. Libraries metadata

```{r}
dev_session_info   <- devtools::session_info()
utils_session_info <- utils::sessionInfo()

message("Saving `devtools::session_info()` objects in ../metadata/devtools_session_info.rds  ..")
saveRDS(dev_session_info, file = paste0("../metadata/", notebookid, "_devtools_session_info.rds"))
message("Done!\n")

message("Saving `utils::sessionInfo()` objects in ../metadata/utils_session_info.rds  ..")
saveRDS(utils_session_info, file = paste0("../metadata/", notebookid ,"_utils_info.rds"))
message("Done!\n")

dev_session_info$platform
dev_session_info$packages[dev_session_info$packages$attached==TRUE, ]
```

```{r}

```
